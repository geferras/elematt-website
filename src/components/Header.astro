---
import LanguageSelector from './LanguageSelector.astro';
import { getLangFromUrl, useTranslations, translatePath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  { name: t('nav.home'), href: translatePath('/', lang) },
  { name: t('nav.history'), href: translatePath('/historia', lang) },
  {
    name: t('nav.products'),
    href: translatePath('/productos', lang),
    dropdown: [
      {
        name: t('nav.babyMat'),
        href: translatePath('/productos/alfombra-bebe', lang),
      },
    ]
  },
  { name: t('nav.contact'), href: translatePath('/contacto', lang) },
];

const logoImage = '/brand/pep-elefante.jpg';

const currentPath = Astro.url.pathname;
---

<header class="header">
  <div class="container">
    <nav class="nav">
      <!-- Logo -->
      <a href="/" class="logo">
        <img src={logoImage} alt="ELEMATT" class="logo-img" />
      </a>

      <!-- Menu Toggle (Mobile) -->
      <button class="menu-toggle" aria-label="Toggle menu" id="menuToggle">
        <span class="hamburger"></span>
      </button>

      <!-- Navigation -->
      <ul class="nav-menu" id="navMenu">
        {navItems.map((item) => (
          <li class={`nav-item ${item.dropdown ? 'has-dropdown' : ''}`}>
            {item.dropdown ? (
              <>
                <button class="nav-link dropdown-toggle" aria-expanded="false">
                  {item.name}
                  <svg class="dropdown-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <ul class="dropdown-menu">
                  {item.dropdown.map((subItem) => (
                    <li>
                      <a
                        href={subItem.href}
                        class={`dropdown-link ${currentPath === subItem.href ? 'active' : ''}`}
                      >
                        {subItem.name}
                      </a>
                    </li>
                  ))}
                </ul>
              </>
            ) : (
              <a
                href={item.href}
                class={`nav-link ${currentPath === item.href ? 'active' : ''}`}
              >
                {item.name}
              </a>
            )}
          </li>
        ))}

        <!-- Language Selector -->
        <li class="nav-item nav-lang">
          <LanguageSelector />
        </li>
      </ul>
    </nav>
  </div>
</header>

<style>
  .header {
    background-color: var(--color-blanco);
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: all var(--transition-normal);
  }

  .nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    z-index: 1001;
  }

  .logo-img {
    height: 48px;
    width: auto;
    transition: opacity var(--transition-fast);
  }

  .logo:hover .logo-img {
    opacity: 0.85;
  }

  .menu-toggle {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.75rem;
    min-width: 48px;
    min-height: 48px;
    position: relative;
    z-index: 1001;
    -webkit-tap-highlight-color: transparent;
  }

  .hamburger,
  .hamburger::before,
  .hamburger::after {
    width: 25px;
    height: 3px;
    background-color: var(--color-salvia);
    border-radius: 2px;
    transition: all var(--transition-fast);
    display: block;
  }

  .hamburger {
    position: relative;
  }

  .hamburger::before,
  .hamburger::after {
    content: '';
    position: absolute;
    left: 0;
  }

  .hamburger::before {
    top: -8px;
  }

  .hamburger::after {
    top: 8px;
  }

  .menu-toggle.active .hamburger {
    background-color: transparent;
  }

  .menu-toggle.active .hamburger::before {
    transform: rotate(45deg);
    top: 0;
  }

  .menu-toggle.active .hamburger::after {
    transform: rotate(-45deg);
    top: 0;
  }

  .nav-menu {
    display: flex;
    gap: 2.5rem;
    list-style: none;
    align-items: center;
  }

  .nav-item {
    position: relative;
  }

  .nav-link {
    font-family: var(--font-primary);
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-gris-oscuro);
    text-decoration: none;
    padding: 0.5rem 0;
    position: relative;
    transition: color var(--transition-fast);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background-color: var(--color-melon);
    transition: width var(--transition-normal);
  }

  .nav-link:hover,
  .nav-link.active {
    color: var(--color-salvia);
  }

  .nav-link:hover::after,
  .nav-link.active::after {
    width: 100%;
  }

  /* Language Selector in Nav */
  .nav-lang {
    display: flex;
    align-items: center;
  }

  /* Dropdown */
  .has-dropdown {
    position: relative;
  }

  .dropdown-toggle {
    cursor: pointer;
  }

  .dropdown-icon {
    transition: transform var(--transition-fast);
  }

  .has-dropdown:hover .dropdown-icon {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--color-blanco);
    box-shadow: var(--shadow-md);
    border-radius: 8px;
    padding: 0.5rem 0;
    min-width: 220px;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-fast);
    z-index: 1000;
    margin-top: 0.5rem;
  }

  .has-dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.5rem;
    color: var(--color-gris-oscuro);
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all var(--transition-fast);
  }

  .dropdown-link:hover,
  .dropdown-link.active {
    background-color: var(--color-perla);
    color: var(--color-salvia);
  }

  /* Responsive - Mobile First */
  @media (max-width: 768px) {
    .nav {
      padding: 0.875rem 0;
    }

    .logo-img {
      height: 42px;
    }

    .menu-toggle {
      display: flex;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-blanco);
      flex-direction: column;
      gap: 0;
      padding: 5rem 1.5rem 3rem 1.5rem;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transform: translateX(100%);
      transition: all var(--transition-normal);
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 1000;
      -webkit-overflow-scrolling: touch;
    }

    .nav-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .nav-item {
      width: 100%;
      text-align: center;
      padding: 0;
      margin-bottom: 0.5rem;
      border-bottom: none;
    }

    .nav-link {
      justify-content: center;
      padding: 1rem;
      font-size: 1.125rem;
      min-height: 48px;
      border-radius: 8px;
      transition: all var(--transition-fast);
    }

    .nav-link:hover,
    .nav-link.active {
      background-color: var(--color-perla);
    }

    .nav-link::after {
      display: none;
    }

    /* Language selector mobile */
    .nav-lang {
      width: 100%;
      justify-content: center;
      padding: 1.5rem 0 1rem 0;
      margin-top: 1.5rem;
      border-top: 2px solid var(--color-perla);
    }

    /* Dropdown mobile */
    .dropdown-menu {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      box-shadow: none;
      border-radius: 8px;
      margin-top: 0.5rem;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-normal);
      background-color: var(--color-perla);
    }

    .has-dropdown.active .dropdown-menu {
      max-height: 400px;
      padding: 0.5rem 0;
    }

    .dropdown-link {
      padding: 0.875rem 1.25rem;
      font-size: 1rem;
      min-height: 48px;
      border-radius: 6px;
      margin: 0 0.5rem;
    }

    .dropdown-link:hover {
      background-color: var(--color-lino);
    }

    .dropdown-toggle {
      width: 100%;
    }

  }

  /* Extra small devices (360px - 430px) */
  @media (max-width: 430px) {
    .nav-menu {
      padding: 4.5rem 1rem 2.5rem 1rem;
    }

    .nav-lang {
      padding: 1.25rem 0 0.75rem 0;
      margin-top: 1.25rem;
    }
  }
</style>

<script is:inline>
  function initHeader() {
    // Mobile menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const navMenu = document.getElementById('navMenu');

    if (menuToggle && navMenu) {
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        navMenu.classList.toggle('active');
        menuToggle.classList.toggle('active');
      });
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!target.closest('.nav')) {
        if (navMenu) navMenu.classList.remove('active');
        if (menuToggle) menuToggle.classList.remove('active');
        // Close all dropdowns
        document.querySelectorAll('.has-dropdown').forEach(item => {
          item.classList.remove('active');
        });
      }
    });

    // Dropdown toggle (mobile)
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          e.stopPropagation();
          const parent = toggle.closest('.has-dropdown');
          if (parent) parent.classList.toggle('active');
        }
      });
    });

    // Close menu when clicking on dropdown links
    const dropdownLinks = document.querySelectorAll('.dropdown-link');
    dropdownLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (navMenu) navMenu.classList.remove('active');
        if (menuToggle) menuToggle.classList.remove('active');
        document.querySelectorAll('.has-dropdown').forEach(item => {
          item.classList.remove('active');
        });
      });
    });

    // Close menu when clicking on regular nav links
    const navLinks = document.querySelectorAll('.nav-link:not(.dropdown-toggle)');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (navMenu) navMenu.classList.remove('active');
        if (menuToggle) menuToggle.classList.remove('active');
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }

  // Re-initialize on page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initHeader);
</script>

