---
import { languages, getLangFromUrl, translatePath, type Language } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

const languageCodes: Record<Language, string> = {
  es: 'ES',
  en: 'EN',
  pt: 'PT',
  it: 'IT',
  fr: 'FR',
  de: 'DE',
};
---

<div class="language-selector">
  <button class="lang-button" aria-label="Select language" id="langToggle">
    <span class="lang-code">{languageCodes[currentLang]}</span>
    <span class="lang-name">{languages[currentLang]}</span>
    <svg class="lang-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <ul class="lang-menu" id="langMenu">
    {Object.entries(languages).map(([lang, name]) => (
      <li>
        <a
          href={translatePath(currentPath, lang as Language)}
          class={`lang-option ${lang === currentLang ? 'active' : ''}`}
          hreflang={lang}
        >
          <span class="lang-code">{languageCodes[lang as Language]}</span>
          <span class="lang-name">{name}</span>
        </a>
      </li>
    ))}
  </ul>
</div>

<style>
  .language-selector {
    position: relative;
    display: inline-block;
  }

  .lang-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-blanco);
    border: 1px solid var(--color-gris-claro);
    border-radius: 8px;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-secondary);
    font-size: 0.9rem;
    color: var(--color-salvia);
  }

  .lang-button:hover {
    border-color: var(--color-salvia);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .lang-code {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--color-salvia-dark);
    background: var(--color-lino);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    line-height: 1;
    letter-spacing: 0.5px;
  }

  .lang-name {
    font-weight: 500;
  }

  .lang-icon {
    transition: transform var(--transition-fast);
  }

  .language-selector.active .lang-icon {
    transform: rotate(180deg);
  }

  .lang-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: var(--color-blanco);
    border: 1px solid var(--color-gris-claro);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    list-style: none;
    padding: 0.5rem 0;
    margin: 0;
    min-width: 160px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-fast);
    z-index: 1000;
  }

  .language-selector.active .lang-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--color-gris-oscuro);
    text-decoration: none;
    transition: all var(--transition-fast);
    font-family: var(--font-secondary);
    font-size: 0.9rem;
  }

  .lang-option:hover {
    background: var(--color-perla);
    color: var(--color-salvia);
  }

  .lang-option.active {
    background: var(--color-lino);
    color: var(--color-salvia);
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .language-selector {
      width: 100%;
    }

    .lang-button {
      width: 100%;
      padding: 0.875rem 1.25rem;
      font-size: 1rem;
      min-height: 48px;
      border-radius: 10px;
      justify-content: center;
      border: 2px solid var(--color-salvia);
      background: linear-gradient(135deg, var(--color-lino), var(--color-perla));
    }

    .lang-button:active {
      transform: scale(0.98);
    }

    .lang-flag {
      font-size: 1.4rem;
    }

    .lang-name {
      display: inline;
      font-weight: 600;
    }

    .lang-menu {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      width: 100%;
      min-width: auto;
      border-radius: 10px;
      margin-top: 0.75rem;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      background-color: var(--color-perla);
      border: none;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .language-selector.active .lang-menu {
      max-height: 400px;
      padding: 0.5rem 0;
    }

    .lang-option {
      padding: 1rem 1.5rem;
      font-size: 1.0625rem;
      min-height: 52px;
      border-radius: 8px;
      margin: 0.25rem 0.5rem;
    }

    .lang-option:active {
      transform: scale(0.98);
    }

    .lang-option.active {
      background: var(--color-salvia);
      color: var(--color-blanco);
      font-weight: 700;
    }
  }

  /* Extra small devices (360px - 430px) */
  @media (max-width: 430px) {
    .lang-button {
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      min-height: 46px;
    }

    .lang-flag {
      font-size: 1.3rem;
    }

    .lang-option {
      padding: 0.875rem 1.25rem;
      font-size: 1rem;
      min-height: 50px;
    }
  }
</style>

<script>
  function initLanguageSelector() {
    const langToggle = document.getElementById('langToggle');
    const langSelector = langToggle?.closest('.language-selector');

    if (!langToggle || !langSelector) return;

    // Toggle language menu
    langToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      langSelector.classList.toggle('active');
    });

    // Close menu when clicking outside (desktop only)
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('.language-selector')) {
        langSelector.classList.remove('active');
      }
    });

    // Close menu when pressing Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        langSelector.classList.remove('active');
      }
    });

    // Close language menu when clicking on a language option (mobile)
    const langOptions = langSelector.querySelectorAll('.lang-option');
    langOptions.forEach(option => {
      option.addEventListener('click', () => {
        // Small delay to allow navigation
        setTimeout(() => {
          langSelector.classList.remove('active');
        }, 100);
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSelector);
  } else {
    initLanguageSelector();
  }

  // Re-initialize on page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', initLanguageSelector);
</script>

