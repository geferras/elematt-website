---
import { languages, getLangFromUrl, translatePath, type Language } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

const languageFlags: Record<Language, string> = {
  es: 'ðŸ‡ªðŸ‡¸',
  en: 'ðŸ‡¬ðŸ‡§',
  pt: 'ðŸ‡µðŸ‡¹',
  it: 'ðŸ‡®ðŸ‡¹',
};
---

<div class="language-selector">
  <button class="lang-button" aria-label="Select language" id="langToggle">
    <span class="lang-flag">{languageFlags[currentLang]}</span>
    <span class="lang-name">{languages[currentLang]}</span>
    <svg class="lang-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
  
  <ul class="lang-menu" id="langMenu">
    {Object.entries(languages).map(([lang, name]) => (
      <li>
        <a 
          href={translatePath(currentPath, lang as Language)}
          class={`lang-option ${lang === currentLang ? 'active' : ''}`}
          hreflang={lang}
        >
          <span class="lang-flag">{languageFlags[lang as Language]}</span>
          <span class="lang-name">{name}</span>
        </a>
      </li>
    ))}
  </ul>
</div>

<style>
  .language-selector {
    position: relative;
    display: inline-block;
  }

  .lang-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-blanco);
    border: 1px solid var(--color-gris-claro);
    border-radius: 8px;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: var(--font-secondary);
    font-size: 0.9rem;
    color: var(--color-salvia);
  }

  .lang-button:hover {
    border-color: var(--color-salvia);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .lang-flag {
    font-size: 1.2rem;
    line-height: 1;
  }

  .lang-name {
    font-weight: 500;
  }

  .lang-icon {
    transition: transform var(--transition-fast);
  }

  .language-selector.active .lang-icon {
    transform: rotate(180deg);
  }

  .lang-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: var(--color-blanco);
    border: 1px solid var(--color-gris-claro);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    list-style: none;
    padding: 0.5rem 0;
    margin: 0;
    min-width: 160px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-fast);
    z-index: 1000;
  }

  .language-selector.active .lang-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--color-gris-oscuro);
    text-decoration: none;
    transition: all var(--transition-fast);
    font-family: var(--font-secondary);
    font-size: 0.9rem;
  }

  .lang-option:hover {
    background: var(--color-perla);
    color: var(--color-salvia);
  }

  .lang-option.active {
    background: var(--color-lino);
    color: var(--color-salvia);
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .lang-button {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .lang-name {
      display: none;
    }

    .lang-menu {
      right: auto;
      left: 0;
    }
  }
</style>

<script>
  const langToggle = document.getElementById('langToggle');
  const langMenu = document.getElementById('langMenu');
  const langSelector = langToggle?.closest('.language-selector');

  langToggle?.addEventListener('click', () => {
    langSelector?.classList.toggle('active');
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.language-selector')) {
      langSelector?.classList.remove('active');
    }
  });

  // Close menu when pressing Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      langSelector?.classList.remove('active');
    }
  });
</script>

